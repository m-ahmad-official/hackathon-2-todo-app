# Implementation Plan: AI Chat Backend & MCP Tools

**Branch**: `004-ai-chat-backend` | **Date**: 2026-02-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-ai-chat-backend/spec.md`

## Summary

Implement a stateless FastAPI chat endpoint that accepts natural language messages, processes them through an OpenAI agent, and executes task management operations via MCP tools. The system persists conversations and messages in the database, reconstructs context on each request, and enforces strict user data isolation through JWT authentication. Frontend integration is achieved through well-defined API contracts.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: FastAPI, SQLModel, OpenAI Agents SDK, MCP SDK (Python), Pydantic, python-jose[cryptography], uvicorn
**Storage**: Neon PostgreSQL (existing), SQLModel ORM
**Testing**: pytest, pytest-asyncio, httpx
**Target Platform**: Linux server (containerized deployment)
**Project Type**: Web application (existing frontend + backend structure)
**Performance Goals**: <3s response time for 95% of requests, 50 concurrent requests support, <5s response under load
**Constraints**: Stateless server (no sessions), JWT-based authentication, 60 req/min rate limit per user, 10,000 char message limit
**Scale/Scope**: Multi-tenant system supporting user-scoped conversations and tasks, 90-day message retention

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **AI-Powered Natural Language Task Management**
- PASS: Chat endpoint will accept natural language and use OpenAI agent to interpret intent
- PASS: All task operations accessible through conversational interface
- PASS: AI agent interprets user intent and executes appropriate actions

✅ **Stateless Chat Architecture with Persistent Storage**
- PASS: No server-side session storage, all context from database
- PASS: Conversation and message history stored in database
- PASS: Each request includes JWT for authentication
- PASS: Conversations persist across sessions

✅ **MCP Tool Integration**
- PASS: All task operations executed through MCP tools
- PASS: AI agent uses MCP tools to interact with task management
- PASS: MCP tools encapsulate business logic and data access
- PASS: No direct database access from chat endpoints

✅ **User-Scoped Security**
- PASS: JWT authentication enforced on all chat endpoints
- PASS: Users can only access their own conversations and tasks
- PASS: Database queries filter by authenticated user ID
- PASS: Security context propagated through MCP tool calls

✅ **Conversational Error Handling**
- PASS: AI confirms successful actions with user-friendly messages
- PASS: Errors translated into helpful conversational responses
- PASS: Edge cases handled without technical jargon
- PASS: Failed operations provide actionable guidance

✅ **Spec-Driven Development**
- PASS: Following Spec-Kit Plus workflow (Spec → Plan → Tasks → Implementation)
- PASS: All changes traceable through agentic development process

**Result**: All constitution checks PASS. No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/004-ai-chat-backend/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (API contracts)
│   ├── chat-api.yaml    # OpenAPI spec for chat endpoints
│   └── mcp-tools.md     # MCP tool interface documentation
└── tasks.md             # Phase 2 output (generated by /sp.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── task.py          # Existing
│   │   ├── conversation.py  # NEW: Conversation model
│   │   └── message.py       # NEW: Message model
│   ├── api/
│   │   └── v1/
│   │       ├── tasks.py     # Existing
│   │       └── chat.py      # NEW: Chat endpoints
│   ├── services/
│   │   ├── task_service.py  # Existing
│   │   ├── chat_service.py  # NEW: Chat orchestration
│   │   └── conversation_service.py  # NEW: Conversation management
│   ├── mcp/                 # NEW: MCP server and tools
│   │   ├── server.py        # MCP server setup
│   │   └── tools/
│   │       ├── __init__.py
│   │       ├── add_task.py
│   │       ├── list_tasks.py
│   │       ├── complete_task.py
│   │       ├── delete_task.py
│   │       └── update_task.py
│   ├── agent/               # NEW: AI agent integration
│   │   ├── __init__.py
│   │   ├── chat_agent.py    # OpenAI agent setup
│   │   └── context_builder.py  # Conversation context reconstruction
│   ├── auth/
│   │   └── security.py      # Existing (JWT verification)
│   └── core/
│       ├── config.py        # Existing
│       └── database.py      # Existing
├── tests/
│   ├── contract/
│   │   └── test_chat_api.py      # NEW: API contract tests
│   ├── integration/
│   │   ├── test_chat_flow.py     # NEW: End-to-end chat tests
│   │   └── test_mcp_tools.py     # NEW: MCP tool integration tests
│   └── unit/
│       ├── test_chat_service.py  # NEW
│       ├── test_conversation_service.py  # NEW
│       └── test_mcp_tools.py     # NEW: Individual MCP tool tests
└── alembic/
    └── versions/
        └── xxx_add_conversations_messages.py  # NEW: Migration

frontend/
├── src/
│   └── services/
│       └── chatApi.ts       # NEW: API client for chat endpoints
└── app/
    └── (chat)/              # NEW: Chat UI routes (future Spec-5)
```

**Structure Decision**: Using existing web application structure (Option 2) with backend/ and frontend/ directories. New modules added for chat (api/v1/chat.py), MCP tools (mcp/), AI agent (agent/), and conversation management (services/conversation_service.py).

## Complexity Tracking

> No constitution violations detected. All gates passed.
