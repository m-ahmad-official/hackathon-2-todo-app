openapi: 3.0.3
info:
  title: AI Chat Backend API
  description: |
    RESTful API for conversational task management.
    Users interact with an AI assistant via natural language to manage their tasks.
  version: 1.0.0
  contact:
    name: Todo AI Chatbot Team

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://api.todoapp.com/api/v1
    description: Production server

security:
  - BearerAuth: []

paths:
  /chat/:
    post:
      summary: Send a chat message
      description: |
        Send a natural language message to the AI assistant.
        The AI interprets the message, executes task operations via MCP tools,
        and returns a conversational response.

        - If `conversation_id` is provided, continues existing conversation
        - If `conversation_id` is omitted, creates new conversation
      operationId: sendMessage
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful response from AI assistant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Invalid request (e.g., message too long)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: AI service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /conversations/:
    get:
      summary: List all conversations
      description: Retrieve all conversations for the authenticated user, sorted by most recent activity
      operationId: listConversations
      tags:
        - Conversations
      parameters:
        - name: limit
          in: query
          description: Maximum number of conversations to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of conversations to skip (for pagination)
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /conversations/{conversation_id}:
    get:
      summary: Get conversation with messages
      description: Retrieve a specific conversation with all its messages
      operationId: getConversation
      tags:
        - Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          description: Unique conversation identifier
          schema:
            type: integer
      responses:
        '200':
          description: Conversation with messages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetailResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access denied (not your conversation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete a conversation
      description: Delete a conversation and all its messages
      operationId: deleteConversation
      tags:
        - Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          description: Unique conversation identifier
          schema:
            type: integer
      responses:
        '204':
          description: Conversation deleted successfully
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access denied (not your conversation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from authentication endpoint

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Natural language message from user
          minLength: 1
          maxLength: 10000
          example: "Add a task to buy groceries"
        conversation_id:
          type: integer
          description: Existing conversation ID to continue (omit to start new conversation)
          example: 42

    ChatResponse:
      type: object
      properties:
        conversation_id:
          type: integer
          description: ID of the conversation (new or existing)
          example: 42
        message:
          $ref: '#/components/schemas/Message'
        context:
          $ref: '#/components/schemas/ChatContext'

    Message:
      type: object
      properties:
        content:
          type: string
          description: AI assistant's response text
          example: "I've created a new task: 'Buy groceries'. Is there anything specific you need to buy?"
        sender:
          type: string
          enum: [ai]
          description: Message sender (always 'ai' for responses)
          example: ai
        timestamp:
          type: string
          format: date-time
          description: When the message was created
          example: "2026-02-08T12:34:56Z"

    ChatContext:
      type: object
      description: Metadata about actions taken and state changes
      properties:
        tasks_modified:
          type: array
          items:
            type: integer
          description: IDs of tasks that were created/updated/deleted
          example: [123, 124]
        action_taken:
          type: string
          description: Human-readable description of what the AI did
          example: "Created new task"
        conversation_created:
          type: boolean
          description: True if this was the start of a new conversation
          example: false

    ConversationListResponse:
      type: object
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/ConversationSummary'
        total:
          type: integer
          description: Total number of conversations for user
          example: 15
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0

    ConversationSummary:
      type: object
      properties:
        id:
          type: integer
          example: 42
        created_at:
          type: string
          format: date-time
          example: "2026-02-08T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-08T12:34:56Z"
        message_count:
          type: integer
          description: Total number of messages in conversation
          example: 12
        last_message:
          type: string
          description: Preview of last message (first 100 characters)
          example: "I've completed the task 'Buy groceries'. What's next?"
        title:
          type: string
          description: Optional conversation title
          example: "Shopping Tasks"

    ConversationDetailResponse:
      type: object
      properties:
        conversation:
          $ref: '#/components/schemas/Conversation'

    Conversation:
      type: object
      properties:
        id:
          type: integer
          example: 42
        created_at:
          type: string
          format: date-time
          example: "2026-02-08T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-08T12:34:56Z"
        title:
          type: string
          example: "Shopping Tasks"
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ConversationMessage'

    ConversationMessage:
      type: object
      properties:
        id:
          type: integer
          example: 123
        content:
          type: string
          example: "Add a task to buy groceries"
        sender:
          type: string
          enum: [user, ai]
          example: user
        timestamp:
          type: string
          format: date-time
          example: "2026-02-08T12:34:50Z"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type
          example: "validation_error"
        message:
          type: string
          description: User-friendly error message
          example: "Message content is too long (maximum 10,000 characters)"
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true
